<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recover Subscription â€” JobArmor</title>
    <meta name="description" content="Recover your JobArmor Pro subscription after reinstalling the extension.">

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
                    colors: {
                        'bg-primary': '#0D0D0D',
                        'bg-card': 'rgba(26, 26, 26, 0.8)',
                        'border-color': '#2A2A2A',
                        'border-hover': '#3A3A3A',
                        'text-primary': '#FFFFFF',
                        'text-secondary': '#B0B0B0',
                        'text-muted': '#6B6B6B',
                        'accent-success': '#10B981',
                        'accent-success-dark': '#059669',
                        'accent-danger': '#EF4444',
                        'accent-warning': '#F59E0B',
                    },
                },
            },
        }
    </script>

    <style>
        body {
            background: #0D0D0D;
        }

        .glass-card {
            background: rgba(26, 26, 26, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid #2A2A2A;
        }

        .btn-primary {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 40px rgba(16, 185, 129, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .input-field {
            background: #1A1A1A;
            border: 1px solid #2A2A2A;
            transition: border-color 0.2s;
        }

        .input-field:focus {
            border-color: #10B981;
            outline: none;
        }

        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
        }

        .success-animation {
            animation: successPop 0.5s ease-out;
        }

        @keyframes successPop {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
    </style>
</head>

<body class="font-sans text-text-primary antialiased min-h-screen">

    <!-- Navigation -->
    <nav class="fixed top-0 left-0 right-0 z-50 glass-card border-t-0 border-l-0 border-r-0">
        <div class="max-w-6xl mx-auto px-4">
            <div class="flex items-center justify-between h-16">
                <a href="index.html" class="flex items-center gap-2">
                    <div
                        class="w-8 h-8 rounded-lg bg-gradient-to-br from-accent-success to-accent-success-dark flex items-center justify-center">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
                        </svg>
                    </div>
                    <span class="font-bold text-lg">JobArmor</span>
                </a>
                <div class="hidden md:flex items-center gap-6">
                    <a href="index.html" class="text-text-secondary hover:text-text-primary transition-colors">Home</a>
                    <a href="upgrade.html"
                        class="text-text-secondary hover:text-text-primary transition-colors">Upgrade</a>
                    <a href="recover.html" class="text-accent-success font-medium">Recover</a>
                    <a href="help.html" class="text-text-secondary hover:text-text-primary transition-colors">Help</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="min-h-screen flex flex-col items-center justify-center pt-16 px-4 py-12">

        <!-- Error: No UUID -->
        <div id="error-no-uuid" class="hidden glass-card rounded-xl p-8 max-w-md w-full text-center">
            <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-accent-warning/20 flex items-center justify-center">
                <svg class="w-8 h-8 text-accent-warning" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </div>
            <h2 class="text-xl font-semibold mb-2">New Device Required</h2>
            <p class="text-text-secondary mb-6">Please open this page from the JobArmor extension on your new device to
                transfer your subscription.</p>
            <a href="https://chrome.google.com/webstore" target="_blank"
                class="inline-flex items-center gap-2 text-accent-success hover:underline">
                <span>Install the Extension</span>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M14 5l7 7m0 0l-7 7m7-7H3" />
                </svg>
            </a>
        </div>

        <!-- Recovery Card -->
        <div id="recovery-card" class="hidden glass-card rounded-xl p-8 max-w-md w-full">

            <!-- Header -->
            <div class="text-center mb-8">
                <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-accent-success/10 flex items-center justify-center">
                    <svg class="w-8 h-8 text-accent-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                </div>
                <h1 class="text-2xl font-bold mb-2">Recover Subscription</h1>
                <p class="text-text-secondary text-sm">Reinstalled the extension? Transfer your Pro subscription to this
                    device.</p>
            </div>

            <!-- Step 1: Email -->
            <div id="step-email" class="step active">
                <label class="block text-sm font-medium mb-2">Email Address</label>
                <p class="text-text-muted text-xs mb-3">Enter the email you used during payment.</p>
                <input type="email" id="input-email" placeholder="you@example.com"
                    class="input-field w-full px-4 py-3 rounded-lg text-text-primary mb-4">

                <div id="error-email"
                    class="hidden mb-4 p-3 rounded-lg bg-accent-danger/10 border border-accent-danger/30 text-accent-danger text-sm">
                </div>

                <button onclick="requestOTP()" id="btn-request-otp"
                    class="btn-primary w-full py-3 rounded-lg font-semibold text-white flex items-center justify-center gap-2">
                    <span id="btn-email-text">Send OTP</span>
                    <div id="btn-email-loader" class="loading-spinner hidden"></div>
                </button>
            </div>

            <!-- Step 2: OTP -->
            <div id="step-otp" class="step">
                <div class="flex items-center gap-2 mb-4">
                    <button onclick="goToStep('email')" class="text-text-muted hover:text-text-primary">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <span class="text-sm text-text-muted">Back to email</span>
                </div>

                <label class="block text-sm font-medium mb-2">Enter OTP</label>
                <p class="text-text-muted text-xs mb-3">We sent a 8-digit code to <span id="display-email"
                        class="text-accent-success"></span></p>

                <input type="text" id="input-otp" placeholder="12345678" maxlength="8"
                    class="input-field w-full px-4 py-3 rounded-lg text-text-primary text-center text-2xl tracking-widest mb-4">

                <div id="error-otp"
                    class="hidden mb-4 p-3 rounded-lg bg-accent-danger/10 border border-accent-danger/30 text-accent-danger text-sm">
                </div>

                <button onclick="verifyOTP()" id="btn-verify-otp"
                    class="btn-primary w-full py-3 rounded-lg font-semibold text-white flex items-center justify-center gap-2">
                    <span id="btn-otp-text">Verify & Recover</span>
                    <div id="btn-otp-loader" class="loading-spinner hidden"></div>
                </button>

                <p class="text-center text-text-muted text-xs mt-4">
                    Didn't receive code? <button onclick="requestOTP()"
                        class="text-accent-success hover:underline">Resend OTP</button>
                </p>
            </div>

        </div>

        <!-- Success State -->
        <div id="success-card" class="hidden glass-card rounded-xl p-8 max-w-md w-full text-center success-animation">
            <div
                class="w-20 h-20 mx-auto mb-6 rounded-full bg-gradient-to-br from-accent-success to-accent-success-dark flex items-center justify-center">
                <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
                </svg>
            </div>
            <h2 class="text-2xl font-bold mb-2 text-accent-success">Subscription Recovered!</h2>
            <p class="text-text-secondary mb-6">Your Pro subscription has been transferred to this device. Enjoy!</p>
            <a href="https://www.linkedin.com/jobs"
                class="btn-primary inline-flex items-center gap-2 px-6 py-3 rounded-xl font-semibold text-white">
                <span>Return to LinkedIn</span>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M14 5l7 7m0 0l-7 7m7-7H3" />
                </svg>
            </a>
        </div>

    </div>

    <script>
        // ========== Configuration ==========

        const CONFIG = {
            SUPABASE_URL: 'https://asfnjoigqbvfkoqbvnuv.supabase.co/functions/v1',
        };
        let extensionUUID = null;
        let userEmail = '';

        // DOM elements
        const errorNoUUID = document.getElementById('error-no-uuid');
        const recoveryCard = document.getElementById('recovery-card');
        const successCard = document.getElementById('success-card');
        const stepEmail = document.getElementById('step-email');
        const stepOtp = document.getElementById('step-otp');

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            extensionUUID = urlParams.get('uuid');

            if (!extensionUUID) {
                errorNoUUID.classList.remove('hidden');
            } else {
                recoveryCard.classList.remove('hidden');
            }
        });

        function goToStep(step) {
            stepEmail.classList.remove('active');
            stepOtp.classList.remove('active');

            if (step === 'email') stepEmail.classList.add('active');
            if (step === 'otp') stepOtp.classList.add('active');
        }

        async function requestOTP() {
            const email = document.getElementById('input-email').value.trim();
            if (!email || !email.includes('@')) {
                showError('email', 'Please enter a valid email address.');
                return;
            }

            userEmail = email;
            setLoading('email', true);
            hideError('email');

            try {
                const response = await fetch(`${CONFIG.SUPABASE_URL}/recovery-manager/request-otp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email }),
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to send OTP');
                }

                // Move to OTP step
                document.getElementById('display-email').textContent = email;
                goToStep('otp');

            } catch (error) {
                showError('email', error.message);
            } finally {
                setLoading('email', false);
            }
        }

        async function verifyOTP() {
            const otp = document.getElementById('input-otp').value.trim();
            if (!otp || otp.length !== 8) {
                showError('otp', 'Please enter the 8-digit OTP.');
                return;
            }

            setLoading('otp', true);
            hideError('otp');

            try {
                const response = await fetch(`${CONFIG.SUPABASE_URL}/recovery-manager/verify-otp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: userEmail,
                        otp: otp,
                        new_uuid: extensionUUID,
                    }),
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Invalid OTP');
                }

                // Success!
                recoveryCard.classList.add('hidden');
                successCard.classList.remove('hidden');

            } catch (error) {
                showError('otp', error.message);
            } finally {
                setLoading('otp', false);
            }
        }

        function setLoading(step, loading) {
            if (step === 'email') {
                document.getElementById('btn-request-otp').disabled = loading;
                document.getElementById('btn-email-text').textContent = loading ? 'Sending...' : 'Send OTP';
                document.getElementById('btn-email-loader').classList.toggle('hidden', !loading);
            } else {
                document.getElementById('btn-verify-otp').disabled = loading;
                document.getElementById('btn-otp-text').textContent = loading ? 'Verifying...' : 'Verify & Recover';
                document.getElementById('btn-otp-loader').classList.toggle('hidden', !loading);
            }
        }

        function showError(step, msg) {
            const el = document.getElementById(`error-${step}`);
            el.textContent = msg;
            el.classList.remove('hidden');
        }

        function hideError(step) {
            document.getElementById(`error-${step}`).classList.add('hidden');
        }
    </script>

</body>

</html>